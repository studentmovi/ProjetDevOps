name: Build TripSchool App

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Upgrade pip
      run: |
        python -m pip install --upgrade pip

    - name: Install dependencies
      run: |
        pip install -r app/requirements.txt
        pip install pyinstaller

    - name: Read app version
      id: app_version
      run: |
        $v = Get-Content app/version.txt
        echo "version=$v" >> $env:GITHUB_OUTPUT

    - name: Build main.exe
      run: |
        pyinstaller --onefile app/main.py

    - name: Build launcher.exe
      run: |
        pyinstaller --onefile app/launcher.py

    - name: Prepare release folder
      run: |
        mkdir release
        copy dist\main.exe release\
        copy dist\launcher.exe release\
        copy app\version.txt release\
        copy app\changelog.json release\

    - name: Create ZIP archive
      run: |
        powershell Compress-Archive release pytrip-${{ steps.app_version.outputs.version }}-windows.zip

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: pytrip-${{ steps.app_version.outputs.version }}-windows.zip

    # üîî Discord ‚Äî SUCCESS
    - name: Notify Discord (success)
      if: success()
      run: |
        $payload = @{
          username = "TripSchool CI"
          embeds = @(
            @{
              title = "üöÄ Nouvelle release PyTrip"
              description = "Version **${{ steps.app_version.outputs.version }}** disponible"
              color = 3066993
              fields = @(
                @{
                  name = "Repository"
                  value = "${{ github.repository }}"
                  inline = $true
                },
                @{
                  name = "Version"
                  value = "${{ steps.app_version.outputs.version }}"
                  inline = $true
                },
                @{
                  name = "T√©l√©chargement"
                  value = "[Voir la release](https://github.com/${{ github.repository }}/releases/latest)"
                  inline = $false
                }
              )
              footer = @{
                text = "GitHub Actions ‚Ä¢ CI/CD"
              }
            }
          )
        } | ConvertTo-Json -Depth 5

        Invoke-RestMethod `
          -Uri "${{ secrets.DISCORD_WEBHOOK_URL }}" `
          -Method Post `
          -ContentType "application/json" `
          -Body $payload

    # üîî Discord ‚Äî FAILURE
    - name: Notify Discord (failure)
      if: failure()
      run: |
        $payload = @{
          username = "TripSchool CI"
          embeds = @(
            @{
              title = "‚ùå Build √©chou√©"
              description = "La pipeline pour la version **${{ steps.app_version.outputs.version }}** a √©chou√©."
              color = 15158332
              fields = @(
                @{
                  name = "Logs"
                  value = "[Voir GitHub Actions](https://github.com/${{ github.repository }}/actions)"
                  inline = $false
                }
              )
              footer = @{
                text = "GitHub Actions ‚Ä¢ CI/CD"
              }
            }
          )
        } | ConvertTo-Json -Depth 5

        Invoke-RestMethod `
          -Uri "${{ secrets.DISCORD_WEBHOOK_URL }}" `
          -Method Post `
          -ContentType "application/json" `
          -Body $payload
