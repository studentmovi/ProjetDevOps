name: Build TripSchool App

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Upgrade pip
      run: |
        python -m pip install --upgrade pip

    - name: Install dependencies
      run: |
        pip install -r app/requirements.txt
        pip install pyinstaller

    - name: Read app version
      id: app_version
      run: |
        $v = Get-Content app/version.txt
        echo "version=$v" >> $env:GITHUB_OUTPUT

    - name: Build main.exe
      run: |
        pyinstaller --onefile app/main.py

    - name: Build launcher.exe
      run: |
        pyinstaller --onefile app/launcher.py

    - name: Prepare release folder
      run: |
        mkdir release
        copy dist\main.exe release\
        copy dist\launcher.exe release\
        copy app\version.txt release\
        copy app\changelog.json release\

    - name: Create ZIP archive
      run: |
        powershell Compress-Archive release pytrip-${{ steps.app_version.outputs.version }}-windows.zip

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: pytrip-${{ steps.app_version.outputs.version }}-windows.zip

    # üîî Discord ‚Äî SUCCESS (Version Moderne)
    - name: Notify Discord (success)
      if: success()
      run: |
        # Configuration des liens et donn√©es
        $repoUrl = "https://github.com/${{ github.repository }}"
        $releaseUrl = "$repoUrl/releases/tag/${{ github.ref_name }}"
        $commitUrl = "$repoUrl/commit/${{ github.sha }}"
        $timestamp = [System.DateTime]::UtcNow.ToString("yyyy-MM-ddTHH:mm:ss.fffZ")
        
        # Message du dernier commit (nettoy√©)
        $commitMsg = "${{ github.event.head_commit.message }}" -replace '"', '\"'
        
        # Construction du JSON complexe
        $payload = @{
          username = "TripSchool Builder"
          avatar_url = "https://cdn-icons-png.flaticon.com/512/919/919833.png" # Ic√¥ne Python g√©n√©rique (tu peux changer)
          embeds = @(
            @{
              author = @{
                name = "Succ√®s du d√©ploiement : ${{ github.repository }}"
                url = $repoUrl
                icon_url = "https://github.com/${{ github.actor }}.png" # Avatar de celui qui a push
              }
              title = "üöÄ Nouvelle version ${{ steps.app_version.outputs.version }} publi√©e !"
              url = $releaseUrl
              description = "La compilation Windows a r√©ussi et la release a √©t√© cr√©√©e automatiquement."
              color = 5763719 # Vert agr√©able (Hex: #57F287)
              thumbnail = @{
                url = "https://upload.wikimedia.org/wikipedia/commons/c/c3/Python-logo-notext.svg" # Logo du projet (√† personnaliser)
              }
              fields = @(
                @{
                  name = "üì¶ Version"
                  value = "`tag: ${{ github.ref_name }}`"
                  inline = $true
                },
                @{
                  name = "üë§ Auteur"
                  value = "[${{ github.actor }}](https://github.com/${{ github.actor }})"
                  inline = $true
                },
                @{
                  name = "üìù Commit"
                  value = "[$commitMsg]($commitUrl)"
                  inline = $false
                },
                @{
                  name = "üì• T√©l√©chargement"
                  value = "Click here to download: **[pytrip-${{ steps.app_version.outputs.version }}-windows.zip]($releaseUrl)**"
                  inline = $false
                }
              )
              footer = @{
                text = "TripSchool CI ‚Ä¢ Windows-Latest"
                icon_url = "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
              }
              timestamp = $timestamp
            }
          )
        } | ConvertTo-Json -Depth 10

        Invoke-RestMethod -Uri "${{ secrets.DISCORD_WEBHOOK_URL }}" -Method Post -ContentType "application/json" -Body $payload

    # üîî Discord ‚Äî FAILURE (Version Moderne)
    - name: Notify Discord (failure)
      if: failure()
      run: |
        $repoUrl = "https://github.com/${{ github.repository }}"
        $runUrl = "$repoUrl/actions/runs/${{ github.run_id }}"
        $timestamp = [System.DateTime]::UtcNow.ToString("yyyy-MM-ddTHH:mm:ss.fffZ")

        $payload = @{
          username = "TripSchool Builder"
          avatar_url = "https://cdn-icons-png.flaticon.com/512/919/919833.png"
          embeds = @(
            @{
              author = @{
                name = "√âchec du d√©ploiement"
                icon_url = "https://github.com/${{ github.actor }}.png"
              }
              title = "‚ùå Le build a rencontr√© une erreur"
              url = $runUrl
              description = "La pipeline s'est arr√™t√©e inopin√©ment. Veuillez v√©rifier les logs ci-dessous."
              color = 15548997 # Rouge vif (Hex: #ED4245)
              fields = @(
                @{
                  name = "üöß Version tent√©e"
                  value = "${{ steps.app_version.outputs.version }}"
                  inline = $true
                },
                @{
                  name = "üîç Analyse"
                  value = "[Voir les logs d'erreur sur GitHub]($runUrl)"
                  inline = $false
                }
              )
              footer = @{
                text = "TripSchool CI ‚Ä¢ Erreur critique"
              }
              timestamp = $timestamp
            }
          )
        } | ConvertTo-Json -Depth 10

        Invoke-RestMethod -Uri "${{ secrets.DISCORD_WEBHOOK_URL }}" -Method Post -ContentType "application/json" -Body $payload